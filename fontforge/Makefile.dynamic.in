prefix = @prefix@
exec_prefix = @exec_prefix@

sharedir = @prefix@/share/fontforge
srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir = ..
VPATH = @srcdir@
bindir = @bindir@
libdir = @libdir@
plugindir = $(sharedir)/plugins

LIBTOOL = @LIBTOOL@
CC = @CC@

X_CFLAGS = @X_CFLAGS@
X_LIBS = @X_LIBS@
X_11LIB = @X_11LIB@
X_EXTRA_LIBS = @X_EXTRA_LIBS@
X_PRE_LIBS = @X_PRE_LIBS@
STATIC_LIBS = @STATIC_LIBS@

fontforge_LIBOBJECTS =  autohint.lo autosave.lo autowidth.lo bitmapdlg.lo \
 bitmapview.lo bvedit.lo charview.lo charviewicons.lo cursors.lo \
 cvaddpoints.lo cvexport.lo cvgetinfo.lo cvhints.lo cvimages.lo cvknife.lo \
 cvpalettes.lo cvpointer.lo cvruler.lo cvshapes.lo cvstroke.lo cvtranstools.lo \
 cvundoes.lo dumpbdf.lo dumppfa.lo fontinfo.lo fontview.lo fvcomposit.lo \
 fvfonts.lo fvimportbdf.lo fvmetrics.lo images.lo metricsview.lo \
 parsepfa.lo parsettf.lo prefs.lo psread.lo psunicodenames.lo savefontdlg.lo \
 sfd.lo splashimage.lo splinefill.lo splineoverlap.lo splinesave.lo \
 splinesaveafm.lo splinestroke.lo splineutil.lo splineutil2.lo stamp.lo \
 start.lo tottf.lo transform.lo uiutil.lo utils.lo windowmenu.lo  \
 zapfnomen.lo othersubrs.lo autotrace.lo openfontdlg.lo encoding.lo print.lo \
 problems.lo metafont.lo alignment.lo parsettfbmf.lo \
 macbinary.lo crctab.lo scripting.lo freetype.lo gotodlg.lo search.lo \
 combinations.lo tilepath.lo sftextfield.lo displayfonts.lo ikarus.lo \
 cvhand.lo cvfreehand.lo simplifydlg.lo winfonts.lo tottfgpos.lo tottfaat.lo \
 charinfo.lo splineorder2.lo genttfinstrs.lo ttfinstrs.lo cvgridfit.lo \
 cvdebug.lo showatt.lo kernclass.lo nonlineartrans.lo effects.lo \
 histograms.lo ttfspecial.lo svg.lo parsettfatt.lo contextchain.lo \
 macenc.lo statemachine.lo typofeatures.lo splinerefigure.lo mm.lo \
 parsettfvar.lo tottfvar.lo pua.lo stemdb.lo anchorsaway.lo palmfonts.lo \
 cvdgloss.lo groups.lo parsepdf.lo plugins.lo \
 @FF_EXTRA_FILES@
DIFFOBJS = sfddiff.lo sfd.lo diffstubs.lo stamp.lo
ACORNOBJS = acorn2sfd.lo sfd.lo diffstubs.lo psunicodenames.lo stamp.lo

_CFLAGS = -I$(top_srcdir)/inc -I$(srcdir) -I. @WFLAGS@ $(X_CFLAGS) \
    @DEFS@ '-DSHAREDIR="$(sharedir)"' -DLIBDIR='"$(libdir)"' \
    @CPPFLAGS@ '-DPREFIX="@prefix@"'
CFLAGS = @CFLAGS@ $(_CFLAGS)

LIBS = -rpath $(libdir) $(X_LIBS) ../libgdraw.la ../libgunicode.la \
    $(X_PRE_LIBS) $(X_11LIB) $(X_EXTRA_LIBS) @LIBS@ $(STATIC_LIBS) -L/usr/lib -lm
DLIBS = -rpath $(libdir) ../libgunicode.la @LIBS@ $(STATIC_LIBS) -lm

all: fontforge

../libfontforge.la: $(fontforge_LIBOBJECTS)
	$(LIBTOOL) --mode=link $(CC) -o ../libfontforge.la $(fontforge_LIBOBJECTS) $(LIBS)

fontforge: main.o ../libfontforge.la
	$(LIBTOOL) --mode=link $(CC) -o fontforge main.o ../libfontforge.la $(LIBS)

sfddiff: $(DIFFOBJS)
	$(LIBTOOL) --mode=link $(CC) -o sfddiff $(DIFFOBJS) $(DLIBS)

acorn2sfd: $(ACORNOBJS)
	$(LIBTOOL) --mode=link $(CC) -o acorn2sfd $(ACORNOBJS) $(DLIBS)

# The slight error introduced occasionally by optimization turns out to have
# disasterous effects. This file may not be compiled with the optimizer.
# On the other hand we do need CPPFLAGS to get the right includes...
splinerefigure.lo: $(srcdir)/splinerefigure.c
	$(LIBTOOL) --mode=compile $(CC) -g -c -o splinerefigure.lo $(_CFLAGS) $(srcdir)/splinerefigure.c

%.lo: %.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c $<


clean:
	-rm -f *.lo *.o fontforge sfddiff po/*.mo
	-rm -rf .libs

distclean cleaner: clean
	-rm -f Makefile

install:
	( cd .. ; make install )

# xgettext has caniptions and strips any non-ASCII characters from my strings
# but I do occasionally want to use unicode characters (TeX, arrows, Increment)
# so I have put these messages in utf8.pot which I manage by hand. non-ASCII
# strings work just fine as keys. It does mean that my pot files should be
# viewed in utf8 though.

# I am told that new versions of xgettext support an option --from-code=UTF-8
# unfortunately this works on none of the systems I use, and I haven't found
# it documented. If it worked I would not need utf8.pot.
fontforge.pot: *.c utf8.pot
	xgettext -k_ -kN_ -kS_ -kP_:1,2 -ofontforge.pot *.c ../gdraw/*.c
	cat utf8.pot >> fontforge.pot
